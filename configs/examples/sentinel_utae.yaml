# ============================================================================
# Sentinel-2 Pipeline — UTAE++ (Modernized U-TAE)
# ============================================================================
# This config trains a UTAE++ model on Sentinel-2 time series data.
# UTAE++ is a modernized version of the U-TAE (Temporal Attention Encoder)
# with ConvNeXt blocks, Flash Attention, and deep supervision.
#
# No aerial images are needed — this pipeline works exclusively with
# Sentinel-2 multi-spectral temporal data (10 bands × T timesteps).
#
# Usage:
#   python -m src.pipeline.sentinel_pipeline -c configs/examples/sentinel_utae.yaml
# ============================================================================

data:
  # Sentinel-only pipeline does not require aerial images.
  train:
    masks:    ./data/flair_2_labels_train
    sentinel: ./data/flair_2_sen_train
  val:
    masks:    ./data/flair_2_labels_test
    sentinel: ./data/flair_2_sen_test
  test:
    masks:    ./data/flair_2_labels_test
    sentinel: ./data/flair_2_sen_test

  # Centroids mapping (aerial patch ID → Sentinel super-patch coordinates)
  centroids_path: ./data/flair-2_centroids_sp_to_patch.json

  dataset_version: split_40
  num_classes: 13
  batch_size: 8
  num_workers: 4
  selected_channels: [0, 1, 2, 3, 4]    # Aerial channels (needed for mask pairing)
  other_class_index: 12

  # ---- Sentinel-2 specific options ----

  # Spatial size of the Sentinel-2 crop (in 10m pixels).
  # Larger values provide more spatial context but use more memory.
  sentinel_patch_size: 40

  # Monthly averaging: collapse all timesteps within a month into one.
  # Produces exactly 12 timesteps per year, simplifying temporal modeling.
  use_monthly_average: true

  # Cloud/snow filtering options
  filter_clouds_snow: false                # Enable to remove cloudy/snowy timesteps
  cloud_snow_cover_threshold: 0.6          # Max fraction of cloud/snow coverage
  cloud_prob_threshold: 50                 # Pixel-level cloud probability threshold

  # Data augmentation for Sentinel-2 (simpler than aerial)
  data_augmentation:
    apply_augmentations: false
    augmentations:
      hflip:
        prob: 0.5
      vflip:
        prob: 0.5
      rotation:
        prob: 0.5
        angles: [0, 90, 180, 270]

mlflow:
  name: sentinel-temporal
  run_name: utae_pp_baseline
  tracking_uri: null
  note: "UTAE++ with monthly averages"
  dagshub:
    enabled: false
    repo_owner: your-username
    repo_name: flair-2
    branch: null

model:
  model_type: UTAE                   # Selects the UTAE++ architecture
  encoder_name: na                   # Not applicable for UTAE++
  encoder_weights: null
  activation: null
  dynamic_img_size: false
  in_channels: 10                    # 10 Sentinel-2 spectral bands

  # UTAE++-specific architecture parameters
  model_config:
    # Encoder stage widths (number of channels per stage)
    encoder_widths: [64, 64, 64, 128]

    # Decoder stage widths (symmetric to encoder)
    decoder_widths: [32, 32, 64, 128]

    # Temporal attention head configuration
    n_head: 4                        # Number of attention heads in L-TAE
    d_model: 256                     # Model dimension for L-TAE
    d_k: 4                           # Key dimension per head

mlflow:
  name: sentinel-temporal
  run_name: utae_pp_baseline
  tracking_uri: null
  note: "UTAE++ temporal model"
  dagshub:
    enabled: false
    repo_owner: your-username
    repo_name: flair-2
    branch: null

training:
  device: cuda
  optimizer:
    type: AdamW
    learning_rate: 0.0001
    betas: [0.9, 0.95]
    weight_decay: 0.00001
  lr_scheduler:
    type: ReduceLROnPlateau
    args:
      mode: min
      factor: 0.5
      patience: 3
      threshold: 0.0001
  epochs: 30
  early_stopping_patience: 8
  early_stopping_criterion: loss
  loss_function:
    type: LovaszLoss
    args:
      mode: multiclass

experiment:
  seed: 42
  deterministic: true

evaluation:
  log_confusion_matrix: true
  log_comparison: true
  log_sample_ids: []

visualization:
  language: en
  labels:
    ground_truth: Ground Truth
    prediction: Prediction
    predicted_class: Predicted Class
    actual_class: Actual Class
    confusion_matrix_title: Confusion Matrix
